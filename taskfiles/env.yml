version: "3"

tasks:
  install-envsubst:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç envsubst –≤ bin/"
    cmds:
      - |
        [ -f {{.ENVSUBST}} ] || {
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º envsubst –≤–µ—Ä—Å–∏–∏ {{.ENVSUBST_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/a8m/envsubst/cmd/envsubst@{{.ENVSUBST_VERSION}}
        }
        echo "‚úÖ envsubst —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{.ENVSUBST}}"

  gen:
    desc: "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .env —Ñ–∞–π–ª—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –µ–¥–∏–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    deps: [install-envsubst]
    cmds:
      - |
        ENV_FILE="{{.ENVDIR}}/.env"
        TEMPLATE_FILE="{{.ENVDIR}}/.env.template"
        SCRIPT="{{.ENVDIR}}/generate-env.sh"

        if [ ! -f "$ENV_FILE" ]; then
          if [ -f "$TEMPLATE_FILE" ]; then
            echo "üîÑ –§–∞–π–ª $ENV_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∏–∑ —à–∞–±–ª–æ–Ω–∞ $TEMPLATE_FILE"
            cp "$TEMPLATE_FILE" "$ENV_FILE"
            echo "‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª $ENV_FILE. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."
          else
            echo "‚ùå –®–∞–±–ª–æ–Ω $TEMPLATE_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
        fi

        chmod +x "$SCRIPT"
        # –ü–µ—Ä–µ–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏-–∑–∞–ø—è—Ç—ã–º–∏
        export SERVICES="{{.SERVICES}}"
        ENV_SUBST={{.ENVSUBST}} "$SCRIPT"
