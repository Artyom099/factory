version: "3"

# coverage:test
# coverage:merge
# coverage:html

tasks:
  test:
    desc: "–°—á–∏—Ç–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á—ë—Ç –ø–æ–∫—Ä—ã—Ç–∏—è..."
        rm -rf {{.COVERAGE_DIR}}
        mkdir -p {{.COVERAGE_DIR}}

        total_coverage=0
        module_count=0

        for mod in {{.MODULES}}; do
          if [ -d "$mod/internal" ]; then
            echo "üß™ –ú–æ–¥—É–ª—å: $mod"
            TARGET_PACKAGES=$(cd $mod && go list ./internal/... | grep -v "/mocks" | grep -E '/(api|service)/' | tr '\n' ',')
            if [ -z "$TARGET_PACKAGES" ]; then
              echo "‚ö†Ô∏è  –í –º–æ–¥—É–ª–µ $mod –Ω–µ—Ç –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
              continue
            fi

            go test -v -cover -coverprofile={{.COVERAGE_DIR}}/$mod.out -coverpkg=$TARGET_PACKAGES ./$mod/...

            echo "üßæ –ü–æ–∫—Ä—ã—Ç–∏–µ –¥–ª—è $mod:"
            go tool cover -func={{.COVERAGE_DIR}}/$mod.out | tail -n1

            module_count=$((module_count+1))
          fi
        done

        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

  merge:
    desc: "–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏—è —Ç—Ä—ë—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (inventory, order, payment) –≤ –æ–¥–∏–Ω –æ–±—â–∏–π —Ñ–∞–π–ª"
    deps: [coverage:test]
    cmds:
      - |
        echo "üß© –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ–∫—Ä—ã—Ç–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
        COVERAGE_DIR={{.COVERAGE_DIR}}
        OUTPUT=$COVERAGE_DIR/{{.COVERAGE_FILE}}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        for f in inventory.out order.out payment.out; do
          if [ ! -f "$COVERAGE_DIR/$f" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø–æ–∫—Ä—ã—Ç–∏—è: $COVERAGE_DIR/$f"
            exit 1
          fi
        done

        # –ë–µ—Ä—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        head -n 1 "$COVERAGE_DIR/inventory.out" > "$OUTPUT"

        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π) –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
        for f in inventory.out order.out payment.out; do
          tail -n +2 "$COVERAGE_DIR/$f" >> "$OUTPUT"
        done

        echo "‚úÖ –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –æ—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $OUTPUT"

  html:
    desc: "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-–æ—Ç—á—ë—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
    deps: [coverage:merge]
    cmds:
      - |
        OUTPUT={{.COVERAGE_DIR}}/coverage.html
        echo "üåê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML-–æ—Ç—á—ë—Ç..."
        go tool cover -html={{.COVERAGE_DIR}}/{{.COVERAGE_FILE}} -o $OUTPUT

        echo "üöÄ –û—Ç–∫—Ä—ã–≤–∞–µ–º $OUTPUT"
        if command -v open &> /dev/null; then
          open $OUTPUT  # macOS
        elif command -v xdg-open &> /dev/null; then
          xdg-open $OUTPUT  # Linux
        else
          echo "üìÇ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $OUTPUT (–æ—Ç–∫—Ä–æ–π –≤—Ä—É—á–Ω—É—é)"
        fi
